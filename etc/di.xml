<?xml version="1.0"?>
<!--
/**
 * DISCLAIMER
 *
 * Do not edit this file if you want to update this module for future new versions.
 *
 * @category Shipay
 * @package Shipay_PixQrGateway
 * @copyright Copyright (c) 2021 Shipay
 * @author Shipay <ajuda@shipay.com.br>
 *
 * See LICENSE for license details.
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <preference for="Shipay\PixQrGateway\Api\WebhookInterface" type="Shipay\PixQrGateway\Model\Webhook"/>
    <preference for="Shipay\PixQrGateway\Api\WalletsRepositoryInterface" type="Shipay\PixQrGateway\Model\WalletsRepository"/>

    <virtualType name="ShipayAdapter" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">Shipay\PixQrGateway\Model\Ui\ConfigProvider::CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form</argument>
            <argument name="infoBlockType" xsi:type="string">ShipayConfigurableInfo</argument>
            <argument name="valueHandlerPool" xsi:type="object">ShipayValueHandlerPool</argument>
            <argument name="commandPool" xsi:type="object">ShipayCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="ShipayValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">ShipayConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="ShipayConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">Shipay\PixQrGateway\Gateway\Config\Config</argument>
        </arguments>
    </virtualType>

    <virtualType name="ShipayCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">ShipayAuthorizeCommand</item>
                <item name="refund" xsi:type="string">ShipayRefundCommand</item>
                <item name="void" xsi:type="string">ShipayRefundCommand</item>
                <item name="cancel" xsi:type="string">ShipayCancelCommand</item>
            </argument>
        </arguments>
    </virtualType>


    <!-- CANCEL -->
    <!-- Cancel Command -->
    <virtualType name="ShipayCancelCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">ShipayCancelTransactionBuilder</argument>
            <argument name="transferFactory" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\Client</argument>
            <argument name="validator" xsi:type="object">Shipay\PixQrGateway\Gateway\Validator\CancelResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Request Cancel Transaction Builder -->
    <virtualType name="ShipayCancelTransactionBuilder" type="Shipay\PixQrGateway\Gateway\Request\RequestBuilder">
        <arguments>
            <argument name="builder" xsi:type="object">ShipayCancelBuilderComposite</argument>
        </arguments>
    </virtualType>

    <!-- Request Cancel Transaction Builder Composite -->
    <virtualType name="ShipayCancelBuilderComposite" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">Shipay\PixQrGateway\Gateway\Request\Builder\Cancel</item>
            </argument>
        </arguments>
    </virtualType>
    <!-- CANCEL END -->

    <!-- REFUND -->
    <!-- Refund Command -->
    <virtualType name="ShipayRefundCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">ShipayRefundTransactionBuilder</argument>
            <argument name="transferFactory" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\Client</argument>
            <argument name="validator" xsi:type="object">Shipay\PixQrGateway\Gateway\Validator\RefundReponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Request Refund Transaction Builder -->
    <virtualType name="ShipayRefundTransactionBuilder" type="Shipay\PixQrGateway\Gateway\Request\RequestBuilder">
        <arguments>
            <argument name="builder" xsi:type="object">ShipayRefundBuilderComposite</argument>
        </arguments>
    </virtualType>

    <!-- Request Refund Transaction Builder Composite -->
    <virtualType name="ShipayRefundBuilderComposite" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">Shipay\PixQrGateway\Gateway\Request\Builder\Refund</item>
            </argument>
        </arguments>
    </virtualType>
    <!-- REFUND END -->

    <!-- AUTHORIZE -->
    <!-- Authorize Command -->
    <virtualType name="ShipayAuthorizeCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">ShipayAuthorizeTransactionBuilder</argument>
            <argument name="transferFactory" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Shipay\PixQrGateway\Gateway\Http\Client</argument>
            <argument name="handler" xsi:type="object">ShipayAuthorizeHandler</argument>
            <argument name="validator" xsi:type="object">Shipay\PixQrGateway\Gateway\Validator\GeneralReponseValidator</argument>
        </arguments>
    </virtualType>

    <virtualType name="ShipayAuthorizeTransactionBuilder" type="Shipay\PixQrGateway\Gateway\Request\RequestBuilder">
        <arguments>
            <argument name="builder" xsi:type="object">ShipayAuthorizeBuilderComposite</argument>
        </arguments>
    </virtualType>

    <virtualType name="ShipayAuthorizeBuilderComposite" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="payment" xsi:type="string">Shipay\PixQrGateway\Gateway\Request\Builder\Payment</item>
                <item name="product_items" xsi:type="string">Shipay\PixQrGateway\Gateway\Request\Builder\ProductItems</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Authorize Handler -->
    <virtualType name="ShipayAuthorizeHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="payment_details" xsi:type="string">Shipay\PixQrGateway\Gateway\Response\PaymentDetailsHandler</item>
                <item name="transaction_details" xsi:type="string">Shipay\PixQrGateway\Gateway\Response\TransactionAdditionalInfoHandler</item>
                <item name="transaction_id" xsi:type="string">Shipay\PixQrGateway\Gateway\Response\TransactionIdHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <!-- AUTHORIZE END -->

    <type name="Shipay\PixQrGateway\Gateway\Http\Client">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayPaymentLogger</argument>
            <argument name="converter" xsi:type="object">Shipay\PixQrGateway\Gateway\Converter\JsonToArray</argument>
        </arguments>
    </type>

    <virtualType name="ShipayPaymentLogger" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">Shipay\PixQrGateway\Gateway\Config\Config</argument>
            <argument name="logger" xsi:type="object">ShipayLogger</argument>
        </arguments>
    </virtualType>

    <type name="Shipay\PixQrGateway\Gateway\Converter\JsonToArray">
        <arguments>
            <argument name="serializer" xsi:type="object">Magento\Framework\Serialize\Serializer\Json</argument>
        </arguments>
    </type>

    <type name="Shipay\PixQrGateway\Gateway\Converter\Converter">
        <arguments>
            <argument name="converter" xsi:type="object">Shipay\PixQrGateway\Gateway\Converter\ArrayToJson</argument>
        </arguments>
    </type>

    <virtualType name="ShipayConfigurableInfo" type="Shipay\PixQrGateway\Block\PaymentInfo">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="methodCode" xsi:type="const">Shipay\PixQrGateway\Model\Ui\ConfigProvider::CODE</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Shipay\PixQrGateway\Gateway\Config\Config">
        <arguments>
            <argument name="valueHandlerPool" xsi:type="object">ShipayValueHandlerPool</argument>
            <argument name="methodCode" xsi:type="const">Shipay\PixQrGateway\Model\Ui\ConfigProvider::CODE</argument>
        </arguments>
    </type>

    <virtualType name="ShipayLogger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="critical" xsi:type="object">Shipay\PixQrGateway\Gateway\Logger\Handler\Critical</item>
                <item name="debug" xsi:type="object">Shipay\PixQrGateway\Gateway\Logger\Handler\Debug</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Shipay\PixQrGateway\Gateway\Validator\GeneralReponseValidator">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayLogger</argument>
        </arguments>
    </type>

    <type name="Shipay\PixQrGateway\Gateway\StatusUpdater\Client">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayStatusUpdaterLogger</argument>
        </arguments>
    </type>

    <type name="Shipay\PixQrGateway\Gateway\StatusUpdater\Model\PendingTransaction">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayStatusUpdaterLogger</argument>
        </arguments>
    </type>

    <type name="Shipay\PixQrGateway\Gateway\StatusUpdater\Model\Invoice">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayStatusUpdaterLogger</argument>
        </arguments>
    </type>

    <type name="Shipay\PixQrGateway\Cron\UpdateOrderStatus">
        <arguments>
            <argument name="logger" xsi:type="object">ShipayStatusUpdaterLogger</argument>
        </arguments>
    </type>

    <virtualType name="ShipayStatusUpdaterLogger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers"  xsi:type="array">
                <item name="debug" xsi:type="object">Shipay\PixQrGateway\Gateway\StatusUpdater\Logger\Handler\Debug</item>
                <item name="critical" xsi:type="object">Shipay\PixQrGateway\Gateway\StatusUpdater\Logger\Handler\Critical</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Cli order status -->
    <type name="Magento\Framework\Console\CommandList">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="update_orders_shipay" xsi:type="object">Shipay\PixQrGateway\Console\Command\UpdateStatusCommand</item>
            </argument>
        </arguments>
    </type>
    <!-- Cli order status END -->
</config>
